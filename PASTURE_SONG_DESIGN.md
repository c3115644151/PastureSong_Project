# 牧野之歌 (Pasture Song) - 畜牧系统设计文档

## 1. 系统核心哲学 (Core Philosophy)
畜牧系统不应只是“喂食-繁殖”的简单重复。其核心挑战在于 **“生态容量管理 (Capacity Management)”** 与 **“种群血统演化 (Bloodline Evolution)”**。

*   **独立闭环**: 通过“排泄物-堆肥-饲料”实现内部资源的循环。
*   **非线性增长 (Progressive Complexity)**: 
    *   **基础体验**: 玩家若只进行原版式的简单养殖，机制将保持低干扰，体验接近原版。
    *   **进阶挑战**: 随着玩家开始培育高代数、优良基因的个体，维护成本（环境要求、饲料品质）将显著上升。高收益伴随着高投入与高风险。

---

## 2. 牧场生态系统 (Pasture Ecosystem)
畜牧系统不再基于僵硬的“区块(Chunk)”，而是引入 **“围栏区域 (Enclosure)”** 概念。

### 2.1 区域负载值 (Enclosure Load)
*   **围栏识别**: 系统通过泛洪算法（Flood Fill）识别由围栏、方块封闭的连通区域。
*   **容量计算**: 根据区域内的 **方块总面积**、**草方块占比**、**水源设施** 计算基础容量。
*   **不同动物占据负载**:
    *   鸡: 0.1
    *   羊: 0.5
    *   牛: 1.0

### 2.2 环境动态平衡
*   **过度放牧 (Overgrazing)**: 当 `负载 > 容量` 时，草方块会退化为泥土，动物 **应激值 (Stress)** 升高，产量下降。
*   **生态增益**: 若区块内种有特定植物（如三叶草、苜蓿），会提供额外的生长速度或基因突变率加成。

---

## 3. 生命周期与行为 (Lifecycle & Behavior)
动物不再是永恒存在的“产肉机器”，而是有生命周期的生物。

### 3.1 四大状态阶段
1.  **幼年期 (Juvenile)**: 极度脆弱，需要特定的温控环境（如干草垫、室内）。
2.  **育成期 (Growth)**: 基因性状表达的关键期，食物品质决定最终体型。
3.  **产出期 (Productive)**: 巅峰期，产奶/剪羊毛/产蛋的最佳时机。
4.  **衰老期 (Senior)**: 产出停止，但其基因稳定性最高，是“血统维持”的核心。

### 3.2 应激机制 (Stress System)
应激值分为 **基础应激 (Base Stress)** 与 **临时应激 (Temporary Stress)** 两部分。

*   **基础应激 (Base, Persistent)**:
    *   **来源**: 基因抗性 (Resistance)、环境卫生 (粪便数量)、生命值健康度、区域负载程度、疲劳状态。
    *   **特性**: 长期存在，只有改善环境或治疗动物才能降低。
*   **临时应激 (Temporary, Volatile)**:
    *   **来源**: 外部事件刺激。
        *   **受到伤害**: 根据伤害量增加。
        *   **爆炸/噪音**: 根据距离震源的远近增加。
        *   **恶劣天气**: 下雨/雷暴且无遮挡（露天）时，应激值极速上升。
    *   **特性**: 事件结束后随时间自然衰减。
*   **综合影响**: `Total Stress = Base + Temporary`。当总应激值超过阈值时，触发负面状态（停止生产、染病）。

### 3.3 粪便系统 (Manure)
*   **技术实现**: **方块替换 (Block Replacement)**。
    *   **逻辑**: 仅当动物位于 **草方块 (Grass Block)** 或 **泥土 (Dirt)** 上时，排泄物才会将方块替换为 **灰化土 (Podzol)**。
    *   **防Bug机制**: 避免石头、木板等建筑方块被替换；清理粪便（右键）后，方块会恢复为 **草方块**（即使原本是泥土），实现“施肥”逻辑。
*   **触发条件**:
    *   **野生动物**: 极低频率，自动降解。
    *   **圈养动物**: 高密度或进食后高频排泄。
*   **清理**: 玩家手持铲子右键 -> 获得【有机粪肥】 -> 变回草方块。

---

## 4. 血统遗传学 (Genetics)
复用并扩展耕食系统的孟德尔基因框架，但引入 **“性状特化”**。

### 4.1 核心性状基因对 (Allele Pairs)
*   **V (Vigor) - 生长势**: 决定幼年到成熟的时间。
*   **Q (Quality) - 品质**: 决定肉类的油花分布或牛奶的脂肪含量。
*   **R (Resistance) - 抗性**: 决定应激阈值和对疾病的免疫力。
*   **F (Fertility) - 多产性**: 决定单次产蛋量或双胞胎概率。

### 4.2 血统纯度 (Bloodline Purity)
*   长期自交会导致“近亲衰退”（基因评分下降）。
*   引入“异血杂交”可以触发 **杂种优势 (Hybrid Vigor)**，瞬间突破性状极限。

### 4.3 基因观测与分析 (Observation & Analysis)
*   **梯度式认知**: 性状 -> 表型 -> 基因型。
*   **Tier 1 - 牧夫透镜 (Shepherd's Lens)**:
    *   一种简易的单片镜。
    *   看向动物时，头顶显示简略评级 (S/A/B/C) 与关键状态（如“应激”、“生病”）。
*   **Tier 2 - 基因测序**:
    *   **DNA 采样器 (DNA Sampler)**: 对动物右键提取 DNA 样本。
    *   **基因分析仪 (Genetic Analyzer)**: 将样本放入分析仪（复用耕食系统的种子分析仪逻辑），产出详细的基因图谱，展示具体的等位基因对 (e.g., `V: A-a`, `Q: S-s`)。

---

## 5. 牧野的馈赠 (Bounty of the Pasture)

### 核心限制：【生物疲劳】 (The Exhaustion)
*   **资源耗尽状态 (Depleted)**:
    *   当你对动物进行了一次成功的“特产采集”（QTE成功）后，动物进入此状态。
    *   **视觉反馈**: 动物头上冒出灰色的烟雾粒子，或者材质变暗。
*   **恢复逻辑**:
    *   **自然恢复**: 10-20 分钟（现实时间）。
    *   **加速恢复**: 喂食优质饲料（耕食记产出），星级越高冷却越短。
*   **惩罚**: 疲劳期间强行采集 -> QTE 无法触发，只获得原版产物，应激值上升，可能生病。

### 5.1 奶牛 (Cow)
*   **交互分级**:
    *   **原版交互**: 手持 **【铁桶】** 右键 -> 获得 **原版牛奶** (无 QTE，无消耗)。
    *   **进阶交互**: 手持 **【玻璃瓶】** 右键 -> 触发 QTE -> 获得 **特产奶**。
*   **QTE 玩法**: **【律动挤奶】**
    *   **界面**: 屏幕下方出现波形或左右交替闪烁圆圈。
    *   **操作**: 按节奏 **左键 - 右键** 交替。
    *   **判定**: 完美 -> 特产奶；失败 -> 被踢（扣血中断）。
*   **群系特产**:
    *   **寒冷群系**: **【霜脂牛乳】 (Frost-Fat Milk)** - 抗寒/抗火 Buff，高级烹饪基底。
    *   **炎热群系**: **【浓缩乳酪】 (Condensed Curd)** - 高饱食度干粮，耐储。
    *   **潮湿群系**: **【解毒清乳】 (Antidote Milk)** - 清除 Debuff，短时免疫中毒。

### 5.2 绵羊 (Sheep)
*   **交互分级**:
    *   **原版交互**: 手持 **【剪刀】** 右键 -> 获得 **原版羊毛**。
    *   **进阶交互**: 手持 **【精工剪 (Precision Shears)】** 右键 -> 触发 QTE -> 获得 **特产羊毛**。
*   **QTE 玩法**: **【精准修剪】**
    *   **界面**: 屏幕中心光圈忽大忽小。
    *   **操作**: 光圈收缩到绿色范围时按下左键。
    *   **判定**: 三次全中 -> 特产羊毛；失误 -> 原版羊毛。
*   **群系特产**:
    *   **寒冷群系**: **【极地暖绒】 (Cryo-Fleece)** - 制作御寒衣物、高级床。
    *   **炎热群系**: **【静电硬毛】 (Static Wool)** - 工业材料，充能地毯。
    *   **温和群系**: **【丝滑柔纱】 (Silky Yarn)** - 高级滑翔翼蒙皮，高价贸易品。

### 5.3 鸡 (Chicken)
*   **核心交互**: 手持【刷子】右键梳理。
*   **QTE 玩法**: **【轻手轻脚】**
    *   **界面**: 进度条 + 惊恐值游标。
    *   **操作**: 按住右键增加进度（同时也加惊恐），松开降惊恐。
    *   **判定**: 惊恐爆表前填满进度 -> 特产羽毛。
*   **群系特产**:
    *   **寒冷群系**: **【冰晶硬羽】 (Ice Quill)** - 冰霜箭矢，高级附魔笔。
    *   **炎热群系**: **【余烬飞羽】 (Ember Feather)** - 爆裂箭矢，地灵火属性进化。
    *   **稀有掉落**: **【金壳蛋】 (Golden Shell Egg)** - 代替原版生蛋，昂贵食材/高星小鸡。

### 5.4 猪 (Pig)
*   **核心交互**: 手持【松露铲】带着猪寻宝。
*   **QTE 玩法**: **【嗅觉雷达】**
    *   **机制**: 带着猪在特定群系行走。
    *   **触发**: 猪停下，头顶感叹号，开始拱地。
    *   **操作**: 3秒内对着猪脚下方块挖掘。
    *   **判定**: 成功 -> 特产；慢了 -> 猪吃掉（回血，无产出）。
*   **群系特产**:
    *   **森林/针叶林**: **【黑松露】 (Black Truffle)** - 顶级食材，贸易品。
    *   **沼泽/雨林**: **【沼泽药根】 (Swamp Root)** - 炼金材料。
    *   **沙漠**: **【沙棘块茎】 (Sand Tuber)** - 补水补食。

---

## 6. 独立闭环 (Closed Loop)
1.  **输入**: 粗饲料（原版干草/种子）+ 空间。
2.  **转化**: 动物消化 -> **粪便 (Manure)**。
3.  **处理**: 堆肥桶/发酵池 -> **熟化肥料**。
4.  **反馈**: 熟化肥料 -> 耕食系统 -> **高蛋白牧草**。
5.  **循环**: 高蛋白牧草 -> 畜牧 -> **高星级动物产品**。

---

## 7. 额外机制与模块桥接
*   **屠宰**: “人道补偿”机制，低应激瞬间处死提升肉质。
*   **设备**:
    *   **自动喂食槽**: 降低人工，但无亲密度加成。
    *   **育种围栏**: 降低突变风险。
*   **模块桥接**:
    *   **To Cooking**: 提供高星级食材（3星大理石纹牛肉）。
    *   **To Farming**: 提供高级有机肥，消耗作物副产品。
    *   **To Smithing**: 提供高级皮革/角质。

---

## 8. 技术分析与推荐栈 (Technical Analysis & Stack)

为了确保系统的稳定性、性能以及开发效率，我们将采用以下技术方案，并尽可能复用现有的开源代码库与模块。

### 8.1 核心模块技术分析

#### A. 基因系统 (Genetics)
*   **需求**: 存储 4 对等位基因，支持显隐性遗传、变异、杂交优势。
*   **复用方案**: 
    *   直接复用 `CuisineFarming_Project` 中的 `com.example.cuisinefarming.genetics` 包。
    *   **Class Reuse**: `Allele`, `GenePair`, `GeneData`, `GeneticsManager`。
    *   **扩展**: 需要为动物定义新的 `Trait` (性状) 枚举，适配 V/Q/R/F 属性。

#### B. 数据存储 (Data Storage)
*   **需求**: 将基因、应激值、年龄、性别绑定在实体上。
*   **技术栈**: `PersistentDataContainer (PDC)` (原生 API)。
*   **实现**: 
    *   使用 `NamespacedKey` 存储数据。
    *   数据类型: `PersistentDataType.STRING` (用于序列化基因 JSON), `INTEGER` (年龄, 基础应激值), `DOUBLE` (负载值)。
    *   **优势**: 随实体存档，无需额外的 Database/Config 维护，兼容性好。

#### C. 围栏识别与负载计算 (Enclosure & Load)
*   **需求**: 动态识别连通区域，计算面积与设施。
*   **算法**: **广度优先搜索 (BFS) / 泛洪算法 (Flood Fill)**。
    *   **触发**: 定时任务（低频，如每 5-10 分钟）或 玩家特定操作（放下/破坏围栏时标记“脏”区域等待重算）。
    *   **性能优化**: 
        *   设置最大搜索深度（如 500 方块），防止遍历整个世界。
        *   异步执行 (Async) 计算，计算完成后回调主线程更新数据。

#### D. QTE 交互系统
*   **需求**: 节奏点击、光圈判定。
*   **参考代码**: 
    *   `CuisineFarming` 中的 `CookingPot` 已经实现了基于 `Tick` 的 QTE 判定逻辑（进度条、成功率计算）。
    *   **GUI**: 使用 `Title` (标题) 或 `Actionbar` (动作栏) 显示实时进度与提示，避免打开箱子界面打断沉浸感。

#### E. 视觉反馈 (Visuals)
*   **需求**: 应激烟雾、升级粒子、粪便效果。
*   **技术栈**: `org.bukkit.Particle`。
*   **库推荐**: 若需复杂粒子轨迹（如 DNA 螺旋特效），可引入 [ParticleNativeAPI](https://github.com/ByteZ1337/ParticleNativeAPI) 或参考 `EffectLib`，但简单的原版粒子足以满足需求且零依赖。


### 8.3 开发路线图 (Roadmap)
1.  **Phase 1 - 基础架构**: 移植 Genetics 模块，实现 PDC 数据读写工具类。
2.  **Phase 2 - 环境互动**: 实现 BFS 围栏识别算法，完成粪便/方块替换逻辑。
3.  **Phase 3 - 实体行为**: 监听事件处理“应激值”波动，实现生命周期（生长、衰老）。
4.  **Phase 4 - 玩家交互**: 开发 QTE 工具（精工剪、玻璃瓶）与 GUI 反馈。
