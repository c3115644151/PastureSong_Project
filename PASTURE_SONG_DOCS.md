# 牧野之歌 (Pasture Song) 操作文档

## 1. 系统概述 (Overview)
**牧野之歌** 是一个深度生物行为与畜牧管理插件。它将原版的简单养殖扩展为包含 **应激管理**、**环境互动**、**基因遗传** 与 **产出疲劳** 的复杂生态系统。玩家需要关注动物的心理健康（应激值）、居住环境（卫生与拥挤度）以及血统纯度（基因），才能获得高品质的特产回报。

核心理念是 **“投入与回报的平衡”**：高产出的动物往往伴随着高维护成本（易应激、需频繁清理粪便）。

---

## 2. 核心架构 (Core Architecture)

| 模块 | 类文件 | 职责 |
| :--- | :--- | :--- |
| **插件核心** | `PastureSong.java` | 插件入口，负责管理器初始化与监听器注册。 |
| **基因核心** | `GeneticsManager.java` | **[核心]** 负责基因的生成、遗传（孟德尔）、突变与 PDC 存储。 |
| **基因数据** | `GeneData.java` | 定义单个动物的完整基因组 (存储 V/Q/R/F 4 对等位基因)。 |
| **应激系统** | `StressManager.java` | **[核心]** 计算基础应激与临时应激，管理应激值的累加与衰减。 |
| **应激监听** | `StressListener.java` | 监听伤害、爆炸等外部事件，转化为临时应激值。 |
| **环境管理** | `EnvironmentManager.java` | 提供 BFS 算法扫描围栏区域，计算生态容量。 |
| **粪便系统** | `ManureManager.java` | 处理动物排泄（方块替换）与玩家清理逻辑。 |
| **粪便监听** | `ManureListener.java` | 监听玩家使用铲子清理粪便的交互。 |
| **生命周期** | `LifecycleListener.java` | **[核心]** 监听生物生成（初始化基因）与繁殖（基因遗传），应用生长速度控制。 |
| **产出疲劳** | `ExhaustionManager.java` | 管理动物的“资源耗尽”状态 (Depleted) 与视觉反馈。 |
| **产出交互** | `ProductionListener.java` | 拦截剪毛/挤奶事件，处理特产获取判定与疲劳惩罚。 |
| **全局任务** | `PastureTask.java` | 5秒周期的心跳任务，处理应激衰减、随机排泄与粒子效果。 |

---

## 3. 详细模块解析 (Detailed Module Analysis)

### 3.1 应激系统 (`StressManager.java`)
应激值 (Stress) 是衡量动物心理健康的核心指标，决定了动物是否会生病或停止生产。

*   **计算公式**: `Total Stress = Base Stress + Temporary Stress`
*   **基础应激 (Base)**:
    *   **来源**: 
        *   基因修正: `RESISTANCE` (抗性) 基因越高，基础应激越低。公式: `- (ResistancePhenotype * 5.0)`。
        *   健康状况: 血量低于 80% 时，基础应激随血量降低而升高。公式: `(0.8 - HealthPct) * 50.0`。
        *   **生物疲劳**: 若处于疲劳状态 (Exhausted)，基础应激恒定 **+10.0** (只要疲劳存在)。
*   **临时应激 (Temporary)**:
    *   **来源**: 外部刺激。
        *   **受到伤害**: `Damage * 10.0`。
        *   **爆炸**: 10格范围内，距离越近应激越高 (Max 100)。
        *   **恶劣天气**: 露天且雷雨天，每 5 秒增加 `2.0` (雨) / `4.0` (雷)。
        *   **疲劳交互**: 若处于疲劳状态，强行进行原版交互 (剪毛/挤奶) 每次 **+20.0**。
    *   **衰减**: 每 5 秒自动衰减 `1.0` 点临时应激。
        *   注意: 临时应激最低衰减至 0，这意味着 **Total Stress** 最低会回归到 **Base Stress** 水平。

### 3.2 环境与区域负载系统 (`EnvironmentManager.java`)
区域负载系统 (Area Load System) 是为了平衡牧场规模与养殖密度的核心机制。它通过“容量 vs 负载”的动态对比，决定牧场是否处于健康状态。

*   **圈地识别 (Enclosure Detection)**:
    *   系统使用 BFS 算法扫描动物所在的封闭空间。
    *   **有效牧场判定条件 (必须全部满足)**:
        1.  **全泥土环境**: 圈内 **所有** 地面方块必须属于 **泥土类** (`GRASS_BLOCK`, `DIRT`, `COARSE_DIRT`, `PODZOL` 等)。若检测到任何非泥土方块 (如石头、木板)，视为无效牧场。
        2.  **植被要求**: 圈内 **至少有一个** `GRASS_BLOCK` (草方块)。
        3.  **封闭性**: 必须由墙、栅栏或实体方块完全围住。

*   **容量计算 (Capacity Calculation)**:
    *   牧场的生态容量并非随面积线性增加，而是呈现对数边际效应递减，模拟自然界的资源限制。
    *   **公式**: `Capacity = Limit * (Area / (Area + K))`
        *   `Limit` (默认 50.0): 无论牧场多大，单体牧场能提供的最大理论容量。
        *   `K` (默认 20.0): 半饱和常数。当 `Area = K` 时，容量达到 `Limit` 的 50%。
    *   **分析**:
        *   小牧场 (20格): 容量约 25 (50%)。扩建收益高。
        *   中牧场 (100格): 容量约 41.6 (83%)。
        *   大牧场 (500格): 容量约 48.0 (96%)。扩建收益极低。
    *   **设计目的**: 鼓励玩家建立多个中小型牧场，而非单一无限大的巨型牧场。

*   **负载计算 (Load Calculation)**:
    *   **公式**: `Current Load = Σ(Entity Load) + Σ(Manure Load)`
    *   **生物负载**: 不同生物占用不同负载值 (如 Cow=1.5, Sheep=1.0)。
    *   **粪便负载**: 每个未清理的粪便 (`PODZOL`) 占用高额负载 (默认 2.0)，迫使玩家定期清理。

*   **过载惩罚 (Overload Penalty)**:
    *   当 `Current Load > Capacity` 时，牧场进入过载状态。
    *   **应激惩罚**: `Penalty = 50 * (Ratio - 1)^2`
        *   过载 20% (Ratio 1.2): 增加 2.0 基础应激。
        *   过载 50% (Ratio 1.5): 增加 12.5 基础应激。
        *   过载 100% (Ratio 2.0): 增加 50.0 基础应激 (灾难级)。
        *   **特点**: 呈指数级增长，轻微过载可容忍，严重过载会导致动物迅速崩溃。
    *   **土地退化**: 动物脚下的草方块有概率退化为泥土，概率随过载比例增加。

### 3.3 粪便与清理系统 (`ManureManager.java`)
    *   **频率**: 每 5 秒有 **5%** 的概率尝试排泄。
    *   **条件**: 动物脚下必须是 `GRASS_BLOCK` (草方块) 或 `DIRT` (泥土)。
    *   **效果**: 将方块替换为 `PODZOL` (灰化土)，并播放泥泞音效。
*   **清理机制**:
    *   **工具**: 任意铲子 (`_SHOVEL`)。
    *   **操作**: 右键点击 `PODZOL`。
    *   **回报**: 方块恢复为 `GRASS_BLOCK`，掉落 `BROWN_DYE` (有机粪肥占位符)。

### 3.3 基因与遗传系统 (`GeneticsManager.java`)
复用了 `CuisineFarming` 的双等位基因架构，定义了 4 种核心性状：

| 基因代号 | 性状 (Trait) | 描述 | 数值影响 |
| :--- | :--- | :--- | :--- |
| **V** | **生长势 (Vitality)** | 决定成熟速度 | **生长速度**: 每点 V 值减少 5% 的幼年时长。 |
| **Q** | **品质 (Quality)** | 决定产物星级 | (Phase 4) 影响特产奶/羊毛的品质判定。 |
| **R** | **抗性 (Resistance)** | 决定应激阈值 | **基础应激**: 每点 R 值降低 5.0 点基础应激。 |
| **F** | **多产性 (Fertility)** | 决定产量 | **额外掉落**: 剪毛时有 `F * 10%` 的概率双倍掉落。 |

*   **表现值计算 (Phenotype Calculation)**:
    *   **杂种优势 (Heterosis)**: 当一对等位基因不同 (杂合子, 如 `A1, A2`) 时，其数值加倍。
    *   **公式**: 
        *   `RawSum = Allele1 + Allele2`
        *   若 `Allele1 != Allele2` (杂合): `Score = RawSum * 2.0`
        *   若 `Allele1 == Allele2` (纯合): `Score = RawSum`
    *   **示例**: `[A2, A1]` -> `(2+1)*2 = 6` (强力优势)。

*   **遗传逻辑**:
    *   **初始化**: 自然生成的动物赋予完全随机的基因。
    *   **繁殖**: 子代从父母的每一对等位基因中各随机继承一个 (孟德尔遗传)。
        *   **突变 (Mutation)**: 遗传过程中，每个等位基因有 5% 的概率发生突变（等级 +1 或 -1）。
    *   **繁殖限制**:
        *   若父母任一方处于 **高应激状态 (>70)** 或 **患病 (Sick)**，繁殖将失败并产生愤怒粒子效果。
    *   **生长控制**: 在子代生成时，根据 V 基因值立即调整其 `Age` (幼年剩余时长)。
        *   公式: `NewAge = -24000 * (1.0 - V * 0.05)`。
        *   例: V=5 (强壮)，只需 18000 tick (15分钟) 成熟；V=-5 (瘦弱)，需 30000 tick (25分钟)。

### 3.4 产出与疲劳系统 (`ProductionListener.java`)
*   **疲劳机制 (Exhaustion)**:
    *   当玩家获取“特产”后，动物进入疲劳状态。
    *   **时长**: 15 分钟 (900,000 ms)。
    *   **效果**: 
        *   持续播放 `SMOKE` (烟雾) 粒子。
        *   **恒定应激**: 疲劳期间 **Base Stress +10.0** (不再随时间累积)。
        *   **交互惩罚**: 疲劳期间强行交互（剪毛/挤奶）每次增加 **+20.0** 临时应激。

*   **产出计算机制 (Output Calculation)**:
    *   **A. 原版产出 (Vanilla Drops)**:
        *   **基础数量**: 屠宰掉落物数量基础增加 **10倍** (补偿区域负载导致的养殖上限降低)。
        *   **基因修正 (Fertility)**: 基于基因分数绝对值进行多次判定，每次 25% 概率增加(正分)或减少(负分) 1个掉落物。
        *   **应激修正 (Stress Multiplier)**:
            *   `<= 0.1` (完美): **1.25x**
            *   `0.1 - 20`: **1.0x** (无修正)
            *   `21 - 50`: **0.7x** (-30%)
            *   `51 - 70`: **0.5x** (-50%)
            *   `71 - 90`: **0.3x** (-70%)
            *   `91 - 100`: **0.1x** (-90%)
    
    *   **B. 特产产出 (Specialty Drops)**:
        *   **前置条件**: 必须在有效牧场内 + 符合生物群系要求 + 动物未疲劳。
        *   **数量公式**: `Multiplier = 1.0 + (FertilityScore / 10.0)`。
            *   例如分数 14 -> 2.4倍。
            *   处理逻辑: **必定掉落 2 个** (整数部分) + **40% 概率额外掉落 1 个** (小数部分)。
    
    *   **C. 品质星级 (Quality Stars)**:
        *   **评分公式**: `Score = (QualityGene * 0.5) + (AvgOtherGenes * 0.5)`。
            *   综合考察品质基因与其他基因的平均水平。
        *   **星级映射** (分数范围 -14 ~ +14):
            *   `>= 8.0`: **★★★★★** (5星)
            *   `>= 2.0`: **★★★★☆** (4星)
            *   `>= -2.0`: **★★★☆☆** (3星)
            *   `>= -8.0`: **★★☆☆☆** (2星)
            *   `< -8.0`: **★☆☆☆☆** (1星)
        *   **应激惩罚**:
            *   应激 > 30: **-1 星**
            *   应激 > 70: **-2 星**
            *   应激 > 99: **强制 1 星** (废品)

*   **交互逻辑**:
    *   **挤奶 (Cow)**:
        *   `BUCKET`: 原版挤奶，若疲劳则增加应激。
        *   `GLASS_BOTTLE`: **特产挤奶**。检查牧场/群系/疲劳 -> 成功则给予特产奶并触发疲劳。
    *   **剪毛 (Sheep)**:
        *   `SHEARS`: 原版剪毛/特产剪毛通用工具 (视是否触发特产判定而定)。
    *   **刷毛 (Chicken)**:
        *   `BRUSH`: 获取特产羽毛。
    *   **挖掘 (Pig)**:
        *   `GOLDEN_SHOVEL`: 获取特产松露。

---

## 3.5 疾病系统 (Disease System)
*(New 2025-12-26)*
疾病系统模拟了恶劣环境和高压状态对动物健康的负面影响。生病的动物不仅会遭受持续的痛苦（应激增加），还会成为传染源威胁整个牧场。

### 3.5.1 感染风险与判定
系统每 5秒 (100 ticks) 对动物进行一次健康检查，判定是否染病。

**风险来源**:
1.  **环境过载 (Manure/Overload)**: 
    *   `Risk += (OverloadRatio - 1.0) * 0.1`
    *   例如：150% 负载 (Ratio 1.5) 增加 5% 风险系数。
2.  **高应激 (High Stress)**:
    *   若应激值 > 70.0，`Risk += 0.05` (5% 风险系数)。
3.  **基因修正 (Resistance)**:
    *   抗性基因 (RESISTANCE) 显著影响风险。
    *   `Risk -= (ResistanceValue * 0.01)`。
    *   例如：抗性 +10 (Phenotype) 降低 10% 风险系数。

**判定公式**:
*   `FinalChance = Risk * 0.1` (实际每 5秒 触发概率为风险系数的 1/10)。
*   例如：总风险系数 0.1 (10%) -> 实际每 5秒 1% 几率染病。

### 3.5.2 症状与流感 (Influenza)
染病动物会有以下表现：
*   **视觉效果**: 间歇性喷嚏粒子效果 (SNEEZE particle)。
*   **应激增加**: 每 5秒 增加 2.0 临时应激。
*   **流感 Buff**: 
    *   动物会持续遭受轻微伤害 (每 5秒 10% 概率受到 1.0 伤害)。
    *   该伤害极其缓慢，但若不加干预最终会导致动物死亡。

### 3.5.3 传染机制 (Transmission)
染病动物每 5秒 有 1% 概率尝试向周围 5格 内的生物传播疾病。

**传播优先级**:
1.  **同类传播**: 优先传染给同种动物 (100% 成功率，受抗性减免)。
2.  **异种传播**: 若无同类，传染给其他家畜 (100% 成功率，受抗性减免)。
3.  **人畜共患**: 若无动物，传染给玩家。
    *   玩家获得 **流感 (Influenza)** 状态：虚弱 (Weakness) + 缓慢 (Slowness) 持续 30秒。
    *   玩家收到提示消息："你感觉有些头晕... (感染流感)"。

### 3.5.4 痊愈与恢复
若满足以下条件，动物有概率自然痊愈：
*   **低应激**: 总应激值 < 30.0。
*   **健康状态**: 血量 > 80%。
*   **恢复概率**: `5% + (ResistanceValue * 1%)` / 每 5秒。

---

## 3.6 基因突变机制 (Genetic Mutation)
*(New 2025-12-26)*
基因不再是一成不变的，它们会随着繁殖和环境压力发生改变。

### 3.6.1 自然繁殖突变
*   **时机**: 动物交配产生后代时。
*   **概率**: 每个等位基因有 **0.1%** 概率发生突变。
*   **效果**: 等位基因值随机 +1 或 -1 (50%/50%)。

### 3.6.2 环境诱导恶性突变
*   **时机**: 动物存活期间，每 5秒 进行一次判定。
*   **触发条件**: 
    *   动物处于 **高应激状态 (>70.0)**。
    *   或 牧场处于 **过载状态 (Overloaded)**。
*   **概率**: 满足条件时，每 5秒 有 **5%** 概率触发突变检查。
*   **效果**: 
    *   检查触发后，有 **50%** 概率发生实际突变 (即总概率 2.5% / 5s)。
    *   **恶性突变**: 基因值 **强制 -1** (降级)。
    *   **视觉反馈**: 动物周围出现黑色烟雾粒子。

---

## 4. 道具与工具 (Items & Tools)

*(Updated 2025-12-26)*

为了方便玩家进行选育和基因管理，插件提供了以下工具：

### 4.1 基因透镜 (Genetic Lens)
*   **物品**: `GENETIC_LENS` (材质: 望远镜)
*   **功能**: 实时观测动物的基因表现。
*   **使用**:
    *   手持透镜 **右键点击** 动物。
    *   **效果**: 在动物头顶显示全息浮空字，列出 4 项基因性状的描述（如“强壮”、“鲜嫩”等）及颜色标识（绿色为正，红色为负）。
    *   *注: 仅显示表现型描述，无法查看具体基因数值。*

### 4.2 DNA 采样器 (DNA Sampler)
*   **物品**: `DNA_SAMPLER` (材质: 燧石)
*   **功能**: 提取动物的基因样本以供深入分析。
*   **使用**:
    *   手持采样器 **右键点击** 动物。
    *   **代价**: 动物受到 1.0 点伤害，增加 15.0 点临时应激。
    *   **产出**: 获得一份 **未鉴定的 DNA 样本** (`DNA Sample (Unidentified)`)。

### 4.3 DNA 样本 (DNA Sample)
*   **物品**: `DNA_SAMPLE` (材质: 纸)
*   **状态**:
    *   **未鉴定**: 无法查看任何信息。
    *   **已鉴定**: 显示完整的基因图谱（每对等位基因的具体数值）。
*   **鉴定方法**:
    *   需要配合 **耕食系统 (CuisineFarming)** 的 **遗传分析仪 (Genetic Analyzer)** 使用。
    *   将未鉴定的样本放入分析仪，消耗时间后即可获得已鉴定的样本。

---

## 5. 开发者配置指南 (Configuration)

配置文件 `config.yml` 现已支持调整以下核心数值，位于 `src/main/resources/config.yml`。

### 4.1 区域负载系统 (Environment & Load)
*   **Capacity Limit**: `environment.capacity.limit` (默认 50.0) - 牧场面积带来的最大容量加成。
*   **Capacity K-Value**: `environment.capacity.k_value` (默认 20.0) - 容量增长曲线的半饱和常数。
*   **Manure Load**: `environment.load.manure` (默认 2.0) - 每个粪便方块/实体占用的负载。
*   **Entity Load**: `environment.load.animals.<TYPE>` - 不同生物的负载值。
    *   `COW`: 1.5
    *   `SHEEP`: 1.0
    *   `PIG`: 1.2
    *   `CHICKEN`: 0.5
    *   `HORSE`: 2.0
    *   Default: 1.0

### 4.2 任务频率
*   `PastureTask`: 运行周期 **100 ticks (5秒)**。
    *   位置: `PastureSong.java` -> `onEnable()`

### 4.3 应激数值 (`StressManager` / `StressListener` / `PastureTask`)
*   **应激衰减**: `-1.0` / 5秒 (减去临时应激，Total趋向Base)。
*   **伤害转化**: `Damage * 10.0`。
*   **爆炸转化**: Max `100.0`。
*   **雷雨增加**: `2.0` (雨) / `4.0` (雷) / 5秒。
*   **疲劳恒定**: `+10.0` (Base Stress Modifier)。
*   **疲劳交互**: `+20.0` (Temporary Stress)。
*   **粒子阈值**: `> 50.0`。

### 4.4 生态与负载数值 (`EnvironmentManager` / `ManureManager`)
*   **排泄概率**: `0.05` (5%) / 5秒。即平均 100秒 排泄一次。
*   **有效地面**: `DIRT_LIKE_SET` (Grass, Dirt, Coarse Dirt, Podzol, Mycelium, etc.)。
*   **过载惩罚**: 
    *   Stress: `50 * (Ratio-1)^2`。
    *   Degradation: `(Ratio-1) * 0.1` chance.

### 4.4 生长数值 (`LifecycleListener`)
*   **生长加速**: `0.05` (5%) per V-point。
*   **基础幼年期**: `-24000` ticks。

### 4.5 疲劳数值 (`ProductionListener` / `ExhaustionManager`)
*   **疲劳时长**: `15 * 60 * 1000` ms (15分钟)。

### 4.6 基因数值 (`Allele` / `GenePair`)
*   **等位基因值**: `±1` (Tier 1) 到 `±4` (Tier 4)。
*   **杂种优势系数**: `2.0` (RawSum * 2.0)。
